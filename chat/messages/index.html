<script src="../../js/libraries/jquery-2.1.1.js" type="text/javascript"></script>
<script src="../../js/libraries/jquery-cookie/jquery.cookie.js" type="text/javascript"></script>
<script src="../../js/Main.js" type="text/javascript"></script>
<script src="http://vk.com/js/api/openapi.js" type="text/javascript"></script>
<script type="text/javascript">
    var messages;
    var winf = true;
    VK.Widgets.Group("vk_groups", {
        mode: 0,
        width: "225",
        height: "250",
        color1: 'FFFFFF',
        color2: '2B587A',
        color3: '0064af'},
    87386085);
    window.onfocus = function () {
        winf = true;
    };
    window.onblur = function () {
        winf = false;
    };
    window.onload = function() {
        if(!isAuthorized()){
            document.location.href = document.location.origin;
        }
        loadPage($.cookie('language'));
        $.ajax({
            type: "POST",
            url: "../../ajax/viewLatestMessages.php",
            data: "",
            success: function (data) {
                messages = (JSON.parse(data));
                for (var i=0; i<messages.length; i++) {
                    document.getElementById("messages").innerHTML +=
                            '<table><tr>' +
                            '<td>' + messages[i][0] + '</td>' +
                            '<td>' + messages[i][2] + '</td>' +
                            '<td>' + messages[i][3] + '</td>' +
                            '</tr></table>'
                }
                document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
            }
        });
        document.getElementById("msgText").focus();
        setTimeout(function() {
            setInterval(function() {updateMessages()}, 1000);
        },1000);
    };
    window.onkeydown = function (e) {
        if (e.which == 13) {
            sendMessage();
        }
    };

    function selectLang(lang) {
        $.cookie('language', lang, {path:'/'});
        document.getElementById("div-header").innerHTML = getHeader($.cookie('language'));
    }

    function sendMessage() {
        if(document.getElementById("msgText").value != '') {
            var userFrom, userTo;
            if ($.cookie('user') == 6) {
                userFrom = 6;
                userTo = 7;
            } else {
                userFrom = 7;
                userTo = 6;
            }
            $.ajax({
                type: "POST",
                url: "../../ajax/sendMessage.php",
                data: "userFromId=" + userFrom + "&userToId=" + userTo + "&text=" + document.getElementById("msgText").value,
                success: function () {
                    document.getElementById("msgText").value = '';
                    document.getElementById("msgText").focus();
                }
            });
        }
    }

    function updateMessages() {
        var lastDate;
        if (messages.length == 0) {
            lastDate = '2000-01-01 00:00:00';
        } else {
            lastDate = messages[messages.length-1][3];
        }
        $.ajax({
            type: "POST",
            url: "../../ajax/viewUnreadMessages.php",
            data: "lastMessageDate=" + lastDate,
            success: function (data) {
                var length = messages.length;
                messages = messages.concat(JSON.parse(data));
                for (var i=length; i<messages.length; i++) {
                    document.getElementById("messages").innerHTML +=
                            '<table><tr>' +
                            '<td>' + messages[i][0] + '</td>' +
                            '<td>' + messages[i][2] + '</td>' +
                            '<td>' + messages[i][3] + '</td>' +
                            '</tr></table>';
                }
                if(length != messages.length && fromOther(length) && !winf) {
                    var audio = new Audio('../../music/notification.mp3');
                    audio.play();
                    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
                }
            }
        });
    }

    function fromOther(from) {
        for (var i=from; i<messages.length; i++) {
            if(messages[i][0] != $.cookie('user')) {
                return true;
            }
        }
        return false;
    }
</script>
<html>
<head>
    <title>Your English Friend</title>
    <link rel="shortcut icon" href="../../images/icon.png" type="image/png">
    <link rel="stylesheet" type="text/css" href="../../css/template.css"/>
</head>
<body class="body">
<table style="border-collapse: collapse; margin: 0; padding: 0; border: 0; width: 100%;">
    <tr style="margin: 0; padding: 0; border: 0">
        <td colspan="2" id="div-header" style="margin: 0; padding: 0; border: 0">
        </td>
    </tr>
    <tr style="margin: 0; padding: 0; border: 0; vertical-align: top;">
        <td style="padding: 10px; width: 1500px" id="div-content">
            <p class="page-header">Сообщения</p>
            <select id="user-id">
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
            </select>
            <div id="messages" style="width: 500px; height: 200px; border: 1px solid #CCCCCC; overflow: auto;"></div>
            <textarea id="msgText" cols="30" rows="10" placeholder="Input your message..."></textarea><br>
            <input type="button" value="Send Message" onclick="sendMessage()"/>
            <input type="button" value="Update Message" onclick="updateMessages()"/>
        </td>
        <td id="div-ads" align="center" style="margin: 0; padding: 0; border: 0; width: 225px; text-align: center; border-left: 1px dotted #0064af;">
        </td>
    </tr>
    <tr style="margin: 0; padding: 0; border: 0">
        <td class="footer" colspan="2" id="div-footer">
        </td>
    </tr>
</table>
</body>
</html>